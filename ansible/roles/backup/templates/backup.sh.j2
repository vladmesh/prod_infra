#!/bin/bash
set -euo pipefail

export RESTIC_REPOSITORY="{{ backup_repository }}"
export RESTIC_PASSWORD_FILE="/opt/backup/.restic-password"

# For S3 backends - set these in environment or here
# export AWS_ACCESS_KEY_ID="your-key"
# export AWS_SECRET_ACCESS_KEY="your-secret"

echo "[$(date)] Starting backup..."

# Initialize repo if needed (idempotent)
restic snapshots &>/dev/null || restic init

# Backup configured paths
{% for path in backup_paths %}
restic backup {{ path }}
{% endfor %}

# Prune old backups (keep last 7 daily, 4 weekly, 6 monthly)
restic forget --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --prune

echo "[$(date)] Backup complete"
