#!/bin/bash
# Service deployment script - auto-generated by Ansible
# Usage: ./deploy.sh <service_name> <github_repo> [branch] [compose_file]

set -euo pipefail

if [ $# -lt 2 ]; then
    echo "Usage: $0 <service_name> <github_repo> [branch] [compose_file]"
    echo "Example: $0 myapp user/myapp main docker-compose.prod.yml"
    exit 1
fi

SERVICE=$1
REPO=$2
BRANCH=${3:-main}
COMPOSE_FILE=${4:-docker-compose.prod.yml}

TOKEN=$(cat /opt/secrets/github_token)

echo "[$(date)] Deploying $SERVICE from $REPO ($BRANCH)..."

mkdir -p /opt/services/$SERVICE

echo "Downloading $COMPOSE_FILE..."
curl -sf -H "Authorization: token $TOKEN" \
    "https://raw.githubusercontent.com/$REPO/$BRANCH/$COMPOSE_FILE" \
    -o "/opt/services/$SERVICE/docker-compose.yml"

cd /opt/services/$SERVICE

echo "Pulling images..."
docker compose pull

echo "Starting containers..."
docker compose up -d

echo "[$(date)] $SERVICE deployed successfully"
docker compose ps
